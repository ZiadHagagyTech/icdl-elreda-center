<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة التحكم | ICDL - Ziad Hagagy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;700&family=Inter:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1748b9;
      --accent: #f59e42;
      --danger: #d53a2c;
      --danger-hover: #b02100;
      --success: #13a041;
      --bg: #f4f7fb;
      --white: #fff;
      --gray: #d6e0f0;
      --text: #23395d;
      --border: #e0e6ef;
      --shadow: 0 4px 20px #02204314;
      --radius: 16px;
      --transition: 0.2s all;
    }
    html, body {
      font-family: 'Cairo', 'Inter', Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text);
      min-height: 100vh;
      box-sizing: border-box;
      scroll-behavior: smooth;
    }
    .navbar {
      background: var(--white);
      box-shadow: var(--shadow);
      padding: 0 24px;
      height: 62px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 2000;
      border-bottom: 1.5px solid var(--gray);
    }
    .navbar .logo {
      font-family: 'Inter', 'Cairo', Arial, sans-serif;
      font-size: 1.25em;
      font-weight: bold;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 7px;
      letter-spacing: 1px;
    }
    .navbar nav {
      display: flex;
      gap: 18px;
    }
    .navbar nav a {
      color: var(--text);
      text-decoration: none;
      font-weight: 500;
      font-size: 1em;
      padding: 6px 18px;
      border-radius: 7px;
      transition: var(--transition);
    }
    .navbar nav a:hover, .navbar nav a.active {
      background: var(--primary);
      color: var(--white);
    }
    .login-modal {
      position: fixed;
      top: 62px;
      left: 0; right: 0; bottom: 0;
      background: #dde3ef;
      z-index: 1600;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.25s;
      min-height: calc(100vh - 62px);
    }
    .login-modal.hide { display: none !important; }
    .login-box {
      background: #fff;
      padding: 38px 32px 24px 32px;
      border-radius: 16px;
      box-shadow: 0 4px 40px #02204341;
      min-width: 320px;
      max-width: 95vw;
      text-align: center;
      border: 2px solid var(--primary);
      animation: fadeInUp 0.6s;
      z-index: 1800;
      position: relative;
    }
    .login-box h2 {
      color: var(--primary);
      margin-bottom: 16px;
      font-weight: bold;
      font-size: 1.18em;
    }
    .login-box label {
      color: var(--primary);
      font-weight: bold;
      margin-top: 12px;
      display: block;
      text-align: right;
    }
    .login-box input[type="text"],
    .login-box input[type="password"] {
      width: 98%;
      padding: 10px 8px;
      font-family: inherit;
      font-size: 1.11em;
      margin-bottom: 16px;
      margin-top: 5px;
      border: 1.3px solid var(--gray);
      border-radius: 8px;
      transition: border 0.15s;
      background: #f8fbff;
    }
    .login-box input[type="text"]:focus,
    .login-box input[type="password"]:focus {
      border-color: var(--primary);
      outline: none;
    }
    .login-box button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 9px 30px;
      font-size: 1.13em;
      font-family: inherit;
      cursor: pointer;
      font-weight: bold;
      margin-top: 12px;
      margin-bottom: 7px;
      transition: background 0.18s;
    }
    .login-box button:hover { background: var(--primary-hover);}
    .login-error {
      color: #d53a2c;
      margin-bottom: 7px;
      font-size: 1.02em;
      font-weight: bold;
      min-height: 24px;
    }
    .hide { display: none !important; }
    .hide-footer { display: none !important; }
    .main-content {
      max-width: 900px;
      margin: 44px auto 30px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 36px 22px 25px 22px;
      min-height: 320px;
      position: relative;
      overflow: hidden;
      animation: fadeInUp 0.7s;
    }
    .section-title { font-size: 1.27em; font-weight: bold; color: var(--primary-hover); margin: 32px 0 12px 0; letter-spacing: 0.3px; display: flex; align-items: center; gap: 7px;}
    .btn-print { background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 7px 26px; font-size: 1.08em; font-family: inherit; cursor: pointer; font-weight: bold; transition: background 0.18s; margin: 0 0 13px 7px; display: inline-block; }
    .btn-print:hover { background: #c97d1e;}
    .btn-print i { margin-left: 4px;}
    .btn-action {
      background: var(--success);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 13px;
      font-size: 1em;
      font-family: inherit;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.14s;
      margin: 0 2px;
    }
    .btn-action.edit { background: var(--primary); }
    .btn-action.edit:hover { background: var(--primary-hover);}
    .btn-action.delete { background: var(--danger); }
    .btn-action.delete:hover { background: var(--danger-hover);}
    .stats-grid { display: flex; gap: 25px; flex-wrap: wrap; margin-bottom: 20px;}
    .stat-card { background: #e9f0fa; border: 1.2px solid var(--gray); border-radius: 10px; padding: 17px 16px 11px 16px; min-width: 170px; min-height: 80px; flex: 1 1 170px; margin-bottom: 10px; text-align: center; box-shadow: 0 1px 8px #02204309; font-size: 1.13em;}
    .stat-card strong {color: var(--primary);font-size: 1.33em;display: block;margin-bottom: 2px;}
    .tbl { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #f8fbff; border-radius: 7px; overflow: hidden; font-size: 1.04em; box-shadow: 0 1px 9px #02204310;}
    .tbl th, .tbl td { padding: 8px 7px; border: 1px solid #e9e0ff; text-align: center;}
    .tbl th { background: #e5eaf6; color: var(--primary-hover); font-weight: bold; font-size: 1.07em;}
    .tbl tbody tr:nth-child(even) { background: #f2f6fb;}
    .group-names-list { background: #f6f9ff; border: 1.2px solid var(--gray); border-radius: 7px; padding: 13px 7px 10px 7px; margin-bottom: 18px; box-shadow: 0 1px 8px #02204307; direction: rtl;}
    .group-names-list span { display: inline-block; background: var(--accent); color: #fff; border-radius: 6px; padding: 5px 15px; margin: 4px 6px; font-size: 1.08em; font-weight: 500;}
    .group-block {
      background: #f8fbff;
      border: 2px solid #e3eaff;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 19px #2563eb13;
      padding: 14px 8px 22px 8px;
    }
    .group-block-title {
      font-weight: bold;
      color: #2563eb;
      font-size: 1.16em;
      margin: 0 0 13px 0;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    /* تعديل نموذج التعديل */
    .edit-modal {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(45,45,60,0.13);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .edit-modal.hide { display: none !important; }
    .edit-box {
      background: #fff;
      padding: 34px 22px 24px 22px;
      border-radius: 16px;
      box-shadow: 0 4px 40px #02204341;
      min-width: 320px;
      max-width: 97vw;
      text-align: center;
      border: 2px solid var(--primary);
      position: relative;
      font-size: 1.08em;
    }
    .edit-box h2 { color: var(--primary); margin-bottom: 13px;}
    .edit-box input, .edit-box select {
      width: 95%;
      padding: 7px 8px;
      margin: 5px 0 13px 0;
      border: 1.2px solid #d6e0f0;
      border-radius: 8px;
      font-size: 1.09em;
      font-family: inherit;
      transition: border 0.15s;
    }
    .edit-box input:focus, .edit-box select:focus { border-color: var(--primary);}
    .edit-box button { margin-top: 11px;}
    .edit-close {
      position: absolute;
      left: 14px; top: 12px;
      background: transparent;
      color: #ad1818;
      border: none;
      font-size: 1.3em;
      cursor: pointer;
      font-weight: bold;
      transition: color 0.18s;
    }
    .edit-close:hover { color: #d53a2c;}
    @media (max-width:1000px){ .main-content { max-width: 99vw;} .stats-grid { flex-direction: column; gap:10px;}}
    @media (max-width:600px) { .main-content { padding: 4vw 1vw 3vw 1vw; } .navbar { padding: 0 2vw;} .tbl td, .tbl th { font-size: 0.93em; } }
    @media print {
      .navbar, .login-modal, .footer-links, .social, .copy, .btn-print, .btn-action, .edit-modal { display: none !important; }
      .main-content { box-shadow: none; border-radius: 0; margin: 0; }
      .section-title { color: #222; }
      body > *:not(#printArea) { display: none !important; }
      #printArea { display: block !important; }
      .group-block { border: 1px solid #2563eb; box-shadow: none; background: #fff;}
    }
  </style>
</head>
<body>
  <!-- Navbar (Always visible and clickable) -->
  <header class="navbar" id="mainNavbar">
    <div class="logo">ICDL - Ziad Hagagy <i class="bi bi-mortarboard-fill"></i></div>
    <nav>
      <a href="./index.html">الرئيسية</a>
      <a href="./search.html">استعلام</a>
      <a href="./admin.html" class="active">لوحة التحكم</a>
    </nav>
  </header>

  <!-- Login Modal -->
  <div id="loginModal" class="login-modal">
    <form class="login-box" onsubmit="return login(event)">
      <h2><i class="bi bi-lock-fill"></i> تسجيل دخول الإدارة</h2>
      <div class="login-error" id="loginError"></div>
      <label for="adminUser">اسم المستخدم:</label>
      <input type="text" id="adminUser" autocomplete="off" required>
      <label for="adminPass">كلمة المرور:</label>
      <input type="password" id="adminPass" autocomplete="off" required>
      <button type="submit">دخول</button>
    </form>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="edit-modal hide">
    <form class="edit-box" onsubmit="return saveEdit(event)">
      <button type="button" class="edit-close" onclick="closeEditModal()">&times;</button>
      <h2>تعديل بيانات الحجز</h2>
      <input type="hidden" id="editKey">
      <input type="hidden" id="editType">
      <input type="hidden" id="editGroup">
      <label>الاسم:</label>
      <input id="editName" required>
      <label>العنوان:</label>
      <input id="editAddress" required>
      <label>الهاتف:</label>
      <input id="editPhone" required>
      <label>نوع الكورس:</label>
      <select id="editCourse" required>
        <option value="">اختر الكورس</option>
        <option value="icdl">ICDL</option>
        <option value="english">English</option>
        <option value="both">الاثنين معاً (ICDL - English)</option>
      </select>
      <label>تم الدفع:</label>
      <select id="editPaid" required>
        <option value="نعم">نعم</option>
        <option value="لا">لا</option>
      </select>
      <button class="btn-action edit" type="submit">حفظ التعديل</button>
    </form>
  </div>

  <!-- Main Content -->
  <main class="main-content hide" id="adminContent">
    <h2><i class="bi bi-speedometer2"></i> لوحة التحكم والإحصائيات</h2>
    <div class="section-title"><i class="bi bi-bar-chart-line-fill"></i> إحصائيات عامة
      <button class="btn-print" onclick="printStatsAndSummary()"><i class="bi bi-printer"></i> طباعة التفاصيل</button>
    </div>
    <div class="stats-grid" id="mainStats"></div>
    <div class="section-title"><i class="bi bi-cash-coin"></i> إجمالي أسعار الحجوزات الفردية والاثنين معاً</div>
    <div class="stats-grid" id="summaries"></div>
    <div class="section-title"><i class="bi bi-people-fill"></i> أسماء المجموعات</div>
    <div class="group-names-list" id="groupNames"></div>
    <div class="section-title">
      <i class="bi bi-person-lines-fill"></i> تفاصيل الحجز الفردي
      <button class="btn-print" onclick="printTable('tblIndividual', 'تفاصيل الحجز الفردي')"><i class="bi bi-printer"></i> طباعة الجدول</button>
    </div>
    <div style="overflow-x:auto;">
      <table class="tbl" id="tblIndividual">
        <thead>
          <tr>
            <th>#</th>
            <th>الاسم</th>
            <th>العنوان</th>
            <th>الهاتف</th>
            <th>نوع الكورس</th>
            <th>تم الدفع</th>
            <th>المبلغ</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="section-title">
      <i class="bi bi-people"></i> تفاصيل الحجز في المجموعات
    </div>
    <div id="groupsContainer"></div>
  </main>

  <footer id="mainFooter">
    <div class="footer-links">
      <a href="#">عن الموقع</a>
      <a href="#">سياسة الخصوصية</a>
      <a href="#">الشروط والأحكام</a>
    </div>
    <div class="social">
      <a href="#"><i class="bi bi-facebook"></i></a>
      <a href="#"><i class="bi bi-whatsapp"></i></a>
      <a href="#"><i class="bi bi-envelope"></i></a>
    </div>
    <div class="copy">جميع الحقوق محفوظة &copy; زياد حجاجي 2025</div>
  </footer>

  <div id="printArea" style="display:none"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // بيانات تسجيل الدخول
    const ADMIN_USERNAME = "admin";
    const ADMIN_PASSWORD = "4159";
    const COURSE_PRICE = 500;
    firebase.initializeApp({
      apiKey: "AIzaSyB_qOr1RzbdvhFGPefXaTMYmflssfbUrS0",
      authDomain: "icdl-261b4.firebaseapp.com",
      databaseURL: "https://icdl-261b4-default-rtdb.firebaseio.com",
      projectId: "icdl-261b4",
      storageBucket: "icdl-261b4.firebasestorage.app",
      messagingSenderId: "1034739256423",
      appId: "1:1034739256423:web:872187720b49d2a5ebd8c2"
    });
    const db = firebase.database();

    function login(e) {
      e.preventDefault();
      const username = document.getElementById('adminUser').value.trim();
      const password = document.getElementById('adminPass').value;
      if(username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        document.getElementById('loginModal').classList.add('hide');
        document.getElementById('adminContent').classList.remove('hide');
        document.getElementById('mainFooter').classList.remove('hide-footer');
        loadDashboard();
      } else {
        document.getElementById('loginError').innerText = "اسم المستخدم أو كلمة المرور غير صحيحة!";
      }
      return false;
    }

    window.onload = function() {
      document.getElementById('mainFooter').classList.add('hide-footer');
    };

    // حمل البيانات وارسم الجداول
    async function loadDashboard() {
      let stats = {
        countICDL: 0, countEnglish: 0, countBoth: 0,
        totalICDL: 0, totalEnglish: 0, totalBoth: 0,
        paidICDL: 0, paidEnglish: 0, paidBoth: 0,
        totalPaid: 0, totalPersons: 0, totalInGroups: 0, totalIndividual: 0,
        groupNames: [],
        totalIndividualPrice: 0, totalIndividualBothPrice: 0, totalGroupIndividualPrice: 0, totalGroupBothPrice: 0,
      };
      let tblIndRows = "";
      // تحميل الأفراد
      let snapshotInd = await db.ref("individual_requests").once("value");
      let indIndex = 1;
      snapshotInd.forEach(child => {
        const key = child.key;
        const v = child.val();
        let courseType = (v.course || "").toLowerCase();
        let price = 0;
        if(courseType === "icdl")      { price = COURSE_PRICE; stats.countICDL++; stats.totalIndividualPrice += price; }
        else if(courseType === "english") { price = COURSE_PRICE; stats.countEnglish++; stats.totalIndividualPrice += price; }
        else if(courseType === "both" || courseType === "الاثنين معاً") { price = COURSE_PRICE*2; stats.countBoth++; stats.totalIndividualBothPrice += price; }
        else price = 0;
        let paid = v.paid === "نعم" || v.paid === "yes";
        if(courseType === "icdl" && paid) stats.paidICDL += price;
        if(courseType === "english" && paid) stats.paidEnglish += price;
        if((courseType === "both" || courseType === "الاثنين معاً") && paid) stats.paidBoth += price;
        if(paid) stats.totalPaid += price;

        stats.totalPersons++;
        stats.totalIndividual++;

        tblIndRows += `<tr>
          <td>${indIndex++}</td>
          <td>${v.name || ""}</td>
          <td>${v.address || ""}</td>
          <td>${v.phone || ""}</td>
          <td>${displayCourseType(v.course)}</td>
          <td>${v.paid || ""}</td>
          <td>${price} جم</td>
          <td>
            <button class="btn-action edit" onclick="showEditModal('individual','${key}')"><i class="bi bi-pencil"></i></button>
            <button class="btn-action delete" onclick="deletePerson('individual','${key}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>`;
      });
      document.querySelector('#tblIndividual tbody').innerHTML = tblIndRows || `<tr><td colspan="8">لا يوجد حجوزات فردية</td></tr>`;

      // المجموعات
      let snapshotGroups = await db.ref("groups").once("value");
      let groupHtmlBlocks = [];
      snapshotGroups.forEach(groupChild => {
        const groupName = groupChild.key;
        stats.groupNames.push(groupName);
        const requests = groupChild.child("requests");
        let groupRows = "";
        let membersCount = 0;
        let rowIndex = 1;
        if(requests.exists()) {
          requests.forEach(reqChild => {
            const key = reqChild.key;
            const v = reqChild.val();
            let courseType = (v.course || "").toLowerCase();
            let price = 0;
            if(courseType === "icdl")      { price = COURSE_PRICE; stats.countICDL++; stats.totalGroupIndividualPrice += price; }
            else if(courseType === "english") { price = COURSE_PRICE; stats.countEnglish++; stats.totalGroupIndividualPrice += price; }
            else if(courseType === "both" || courseType === "الاثنين معاً") { price = COURSE_PRICE*2; stats.countBoth++; stats.totalGroupBothPrice += price; }
            else price = 0;
            let paid = v.paid === "نعم" || v.paid === "yes";
            if(courseType === "icdl" && paid) stats.paidICDL += price;
            if(courseType === "english" && paid) stats.paidEnglish += price;
            if((courseType === "both" || courseType === "الاثنين معاً") && paid) stats.paidBoth += price;
            if(paid) stats.totalPaid += price;

            stats.totalPersons++;
            stats.totalInGroups++;
            membersCount++;

            groupRows += `<tr>
              <td>${rowIndex++}</td>
              <td>${v.name || ""}</td>
              <td>${v.address || ""}</td>
              <td>${v.phone || ""}</td>
              <td>${displayCourseType(v.course)}</td>
              <td>${v.paid || ""}</td>
              <td>${price} جم</td>
              <td>
                <button class="btn-action edit" onclick="showEditModal('group','${key}','${groupName}')"><i class="bi bi-pencil"></i></button>
                <button class="btn-action delete" onclick="deletePerson('group','${key}','${groupName}')"><i class="bi bi-trash"></i></button>
              </td>
            </tr>`;
          });
        }
        groupHtmlBlocks.push(`
          <div class="group-block">
            <div class="group-block-title"><i class="bi bi-collection"></i> مجموعة: <span>${groupName}</span> <span style="color:#8c8c8c;font-size:0.95em">(عدد الأعضاء: ${membersCount})</span>
              <button class="btn-print" onclick="printGroupTable('${groupName.replace(/'/g,"\\'")}')"><i class="bi bi-printer"></i> طباعة الجدول</button>
            </div>
            <div style="overflow-x:auto;">
              <table class="tbl" id="tblGroup_${encodeURIComponent(groupName)}">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>الاسم</th>
                    <th>العنوان</th>
                    <th>الهاتف</th>
                    <th>نوع الكورس</th>
                    <th>تم الدفع</th>
                    <th>المبلغ</th>
                    <th>إجراءات</th>
                  </tr>
                </thead>
                <tbody>
                  ${groupRows || `<tr><td colspan="8">لا يوجد أعضاء في هذه المجموعة</td></tr>`}
                </tbody>
              </table>
            </div>
          </div>
        `);
      });
      document.getElementById('groupsContainer').innerHTML = groupHtmlBlocks.length ? groupHtmlBlocks.join('') : '<div style="color:#888;">لا توجد مجموعات مسجلة</div>';

      // إحصائيات عامة
      stats.totalICDL = stats.countICDL * COURSE_PRICE;
      stats.totalEnglish = stats.countEnglish * COURSE_PRICE;
      stats.totalBoth = stats.countBoth * COURSE_PRICE * 2;
      let mainStatsHtml = `
        <div class="stat-card">
          <div>عدد الطلبة (الكل):</div>
          <strong>${stats.totalPersons}</strong>
        </div>
        <div class="stat-card">
          <div>عدد الطلبة الأفراد:</div>
          <strong>${stats.totalIndividual}</strong>
        </div>
        <div class="stat-card">
          <div>عدد الطلبة في المجموعات:</div>
          <strong>${stats.totalInGroups}</strong>
        </div>
        <div class="stat-card">
          <div>عدد حجوزات ICDL:</div>
          <strong>${stats.countICDL}</strong>
        </div>
        <div class="stat-card">
          <div>عدد حجوزات English:</div>
          <strong>${stats.countEnglish}</strong>
        </div>
        <div class="stat-card">
          <div>عدد حجوزات الاثنين معاً:</div>
          <strong>${stats.countBoth}</strong>
        </div>
        <div class="stat-card">
          <div>إجمالي المدفوع:</div>
          <strong>${stats.totalPaid} جم</strong>
        </div>
        <div class="stat-card">
          <div>مدفوع ICDL:</div>
          <strong>${stats.paidICDL} جم</strong>
        </div>
        <div class="stat-card">
          <div>مدفوع English:</div>
          <strong>${stats.paidEnglish} جم</strong>
        </div>
        <div class="stat-card">
          <div>مدفوع الاثنين معاً:</div>
          <strong>${stats.paidBoth} جم</strong>
        </div>
      `;
      document.getElementById('mainStats').innerHTML = mainStatsHtml;

      let summariesHtml = `
        <div class="stat-card">
          <div>إجمالي سعر الحجز الفردي (ICDL و English فقط):</div>
          <strong>${stats.totalIndividualPrice + stats.totalGroupIndividualPrice} جم</strong>
        </div>
        <div class="stat-card">
          <div>إجمالي سعر حجز الاثنين معاً:</div>
          <strong>${stats.totalIndividualBothPrice + stats.totalGroupBothPrice} جم</strong>
        </div>
        <div class="stat-card">
          <div>إجمالي جميع الأسعار (كل الدخل):</div>
          <strong>${stats.totalIndividualPrice + stats.totalGroupIndividualPrice + stats.totalIndividualBothPrice + stats.totalGroupBothPrice} جم</strong>
        </div>
      `;
      document.getElementById('summaries').innerHTML = summariesHtml;

      document.getElementById('groupNames').innerHTML = stats.groupNames.length ?
        stats.groupNames.map(name => `<span>${name}</span>`).join("") :
        "<em>لا توجد مجموعات بعد</em>";
    }

    function displayCourseType(type) {
      if (!type) return '';
      if (type.toLowerCase() === "icdl") return "ICDL";
      if (type.toLowerCase() === "english") return "English";
      if (type.toLowerCase() === "both" || type === "الاثنين معاً") return "الاثنين معاً (ICDL - English)";
      return type;
    }

    function printStatsAndSummary() {
      var statsHtml = document.querySelector('.section-title').outerHTML + document.getElementById('mainStats').outerHTML;
      var summariesHtml = document.querySelectorAll('.section-title')[1].outerHTML + document.getElementById('summaries').outerHTML;
      var groupNamesTitle = document.querySelectorAll('.section-title')[2].outerHTML;
      var groupNamesHtml = document.getElementById('groupNames').outerHTML;
      var printArea = document.getElementById('printArea');
      printArea.innerHTML = statsHtml + summariesHtml + groupNamesTitle + groupNamesHtml;
      printArea.style.display = 'block';
      printArea.setAttribute('dir', 'rtl');
      printArea.id = "printArea";
      window.print();
      printArea.innerHTML = "";
      printArea.style.display = 'none';
    }

    function printTable(tableId, title) {
      var tbl = document.getElementById(tableId);
      if (!tbl) return;
      var printArea = document.getElementById('printArea');
      var html = `<h3 style="text-align:center;color:#2563eb;font-family:Cairo,Arial,sans-serif;margin:15px 0">${title}</h3>`;
      html += `<div style="overflow-x:auto;">${tbl.outerHTML}</div>`;
      printArea.innerHTML = html;
      printArea.style.display = 'block';
      printArea.setAttribute('dir', 'rtl');
      window.print();
      printArea.innerHTML = "";
      printArea.style.display = 'none';
    }

    function printGroupTable(groupName) {
      var tbl = document.getElementById('tblGroup_' + encodeURIComponent(groupName));
      if (!tbl) return;
      var html = `<h3 style="text-align:center;color:#2563eb;font-family:Cairo,Arial,sans-serif;margin:15px 0">جدول مجموعة: ${groupName}</h3>`;
      html += `<div style="overflow-x:auto;">${tbl.outerHTML}</div>`;
      var printArea = document.getElementById('printArea');
      printArea.innerHTML = html;
      printArea.style.display = 'block';
      printArea.setAttribute('dir', 'rtl');
      window.print();
      printArea.innerHTML = "";
      printArea.style.display = 'none';
    }

    // حذف شخص (فردي أو مجموعة)
    function deletePerson(type, key, groupName) {
      if (!confirm('هل أنت متأكد من حذف هذا الشخص؟')) return;
      if (type === 'individual') {
        db.ref('individual_requests/' + key).remove().then(() => {
          alert('تم حذف الشخص بنجاح');
          loadDashboard();
        });
      } else if (type === 'group' && groupName) {
        db.ref('groups/' + groupName + '/requests/' + key).remove().then(() => {
          alert('تم حذف الشخص من المجموعة بنجاح');
          loadDashboard();
        });
      }
    }

    // فتح نافذة التعديل
    async function showEditModal(type, key, groupName) {
      let data;
      if (type === 'individual') {
        let snap = await db.ref('individual_requests/' + key).once('value');
        data = snap.val();
      } else if (type === 'group' && groupName) {
        let snap = await db.ref('groups/' + groupName + '/requests/' + key).once('value');
        data = snap.val();
      }
      if(!data) return alert('لا يوجد بيانات!');
      document.getElementById('editKey').value = key;
      document.getElementById('editType').value = type;
      document.getElementById('editGroup').value = groupName || "";
      document.getElementById('editName').value = data.name || '';
      document.getElementById('editAddress').value = data.address || '';
      document.getElementById('editPhone').value = data.phone || '';
      let vCourse = (data.course || '').toLowerCase();
      if (vCourse === 'icdl') document.getElementById('editCourse').value = 'icdl';
      else if (vCourse === 'english') document.getElementById('editCourse').value = 'english';
      else document.getElementById('editCourse').value = 'both';
      document.getElementById('editPaid').value = (data.paid === 'yes' || data.paid === 'نعم') ? 'نعم' : 'لا';
      document.getElementById('editModal').classList.remove('hide');
    }
    function closeEditModal() {
      document.getElementById('editModal').classList.add('hide');
    }
    // حفظ التعديلات
    async function saveEdit(e) {
      e.preventDefault();
      const key = document.getElementById('editKey').value;
      const type = document.getElementById('editType').value;
      const group = document.getElementById('editGroup').value;
      const data = {
        name: document.getElementById('editName').value.trim(),
        address: document.getElementById('editAddress').value.trim(),
        phone: document.getElementById('editPhone').value.trim(),
        course: document.getElementById('editCourse').value,
        paid: document.getElementById('editPaid').value
      };
      if (type === 'individual') {
        await db.ref('individual_requests/' + key).set(data);
      } else if (type === 'group' && group) {
        await db.ref('groups/' + group + '/requests/' + key).set(data);
      }
      alert('تم حفظ التعديلات بنجاح');
      closeEditModal();
      loadDashboard();
    }

    // تعطيل الزر الأيمن
    document.addEventListener("contextmenu", function (e) {
      e.preventDefault();
    });

    // تعطيل اختصارات F12 و Ctrl+Shift+I و Ctrl+Shift+J و Ctrl+U
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" ||
        (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
        (e.ctrlKey && e.key === "U")) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>

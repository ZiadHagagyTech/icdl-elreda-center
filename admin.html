<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة التحكم | ICDL - Ziad Hagagy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;700&family=Inter:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1748b9;
      --accent: #f59e42;
      --danger: #d53a2c;
      --danger-hover: #b02100;
      --success: #13a041;
      --bg: #f4f7fb;
      --white: #fff;
      --gray: #d6e0f0;
      --text: #23395d;
      --border: #e0e6ef;
      --shadow: 0 4px 20px #02204314;
      --radius: 16px;
      --transition: 0.2s all;
      --nav-height: 62px;
      --nav-bottom-height: 75px;
    }
    html, body {
      font-family: 'Cairo', 'Inter', Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text);
      min-height: 100vh;
      box-sizing: border-box;
      scroll-behavior: smooth;
    }
    .navbar-top {
      background: var(--white);
      box-shadow: var(--shadow);
      padding: 0 24px;
      height: var(--nav-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 2000;
      border-bottom: 1.5px solid var(--gray);
      transition: all 0.18s;
    }
    .navbar-top .logo {
      font-family: 'Inter', 'Cairo', Arial, sans-serif;
      font-size: 1.25em;
      font-weight: bold;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 7px;
      letter-spacing: 1px;
    }
    .navbar-top nav {
      display: flex;
      gap: 18px;
      transition: all 0.18s;
    }
    .navbar-top nav a {
      color: var(--text);
      text-decoration: none;
      font-weight: 500;
      font-size: 1em;
      padding: 6px 18px;
      border-radius: 7px;
      transition: var(--transition);
    }
    .navbar-top nav a:hover, .navbar-top nav a.active {
      background: var(--primary);
      color: var(--white);
    }
    .navbar-bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      height: var(--nav-bottom-height);
      background: #fff;
      box-shadow: 0 -2px 22px #02204329;
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
      display: none;
      justify-content: space-around;
      align-items: center;
      z-index: 9999;
      padding: 0 3vw;
    }
    .navbar-bottom a {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--primary-hover);
      text-decoration: none;
      font-size: 1em;
      font-weight: 700;
      transition: color 0.19s;
      padding: 0;
      position: relative;
      height: 100%;
    }
    .navbar-bottom a.active, .navbar-bottom a:hover {
      color: var(--accent);
    }
    .navbar-bottom i {
      font-size: 1.65em;
      margin-bottom: 3px;
      display: block;
    }
    .navbar-bottom span {
      font-size: 0.98em;
      font-family: 'Cairo',sans-serif;
      font-weight: 700;
    }
    .main-content {
      max-width: 900px;
      margin: 44px auto 0;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 36px 22px 25px 22px;
      min-height: 320px;
      position: relative;
      overflow: hidden;
      animation: fadeInUp 0.7s;
    }
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(40px);}
      100% { opacity: 1; transform: translateY(0);}
    }
    .section-title { font-size: 1.27em; font-weight: bold; color: var(--primary-hover); margin: 32px 0 12px 0; letter-spacing: 0.3px; display: flex; align-items: center; gap: 7px;}
    .btn-print { background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 7px 26px; font-size: 1.08em; font-family: inherit; cursor: pointer; font-weight: bold; transition: background 0.18s;}
    .btn-print:hover { background: #c97d1e;}
    .btn-print i { margin-left: 4px;}
    .btn-action {
      background: var(--success);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 13px;
      font-size: 1em;
      font-family: inherit;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.14s;
      margin: 0 2px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .btn-action.edit { background: var(--primary); }
    .btn-action.edit:hover { background: var(--primary-hover);}
    .btn-action.delete { background: var(--danger); }
    .btn-action.delete:hover { background: var(--danger-hover);}
    .btn-action.group-delete {
      background: var(--danger);
      color: #fff;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.08em;
      padding: 0;
      margin: 0 0 0 8px;
      border: none;
      transition: background 0.14s;
    }
    .btn-action.group-delete:hover {
      background: var(--danger-hover);
    }
    .btn-add-group {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 24px;
      font-size: 1.08em;
      font-family: inherit;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 15px;
      transition: background 0.18s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-add-group:hover { background: #c97d1e;}
    .search-box {
      margin: 0 0 23px 0;
      display: flex;
      align-items: center;
      gap: 9px;
      max-width: 340px;
    }
    .search-box input[type="text"] {
      width: 100%;
      padding: 9px 12px;
      border: 1.4px solid var(--gray);
      border-radius: 8px;
      font-size: 1.08em;
      font-family: inherit;
      outline: none;
      transition: border .18s;
    }
    .search-box input[type="text"]:focus {
      border-color: var(--primary);
    }
    .search-box .bi-search {
      color: var(--primary-hover);
      font-size: 1.18em;
      margin-left: 3px;
    }
    .stats-grid { display: flex; gap: 25px; flex-wrap: wrap; margin-bottom: 20px;}
    .stat-card { background: #e9f0fa; border: 1.2px solid var(--gray); border-radius: 10px; padding: 17px 16px 11px 16px; min-width: 170px; min-height: 80px; flex: 1 1 170px; margin-bottom: 10px; text-align: center;}
    .stat-card strong {color: var(--primary);font-size: 1.33em;display: block;margin-bottom: 2px;}
    .stat-card.unpaid {background:#fff3e0;border-color:#f59e42;}
    .stat-card.unpaid strong {color:#d53a2c;}
    .stat-card.special {
      background: #fffbe7;
      border: 2px solid #f59e42;
      color: #8b6e19;
      font-size: 1.12em;
      font-weight: 600;
    }
    .stat-card.special strong {
      color: #ff9800;
      font-size: 1.5em;
      margin-top: 5px;
    }
    .stat-card .stat-note {
      font-size: 0.95em;
      color: #b0850d;
      margin-top: 7px;
      display: block;
    }
    .tbl { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #f8fbff; border-radius: 7px; overflow: hidden; font-size: 1.04em; box-shadow: 0 1px 9px #02204310;}
    .tbl th, .tbl td { padding: 8px 7px; border: 1px solid #e9e0ff; text-align: center;}
    .tbl th { background: #e5eaf6; color: var(--primary-hover); font-weight: bold; font-size: 1.07em;}
    .tbl tbody tr:nth-child(even) { background: #f2f6fb;}
    .tbl th.details-col,
    .tbl td.details-col {
      min-width: 110px;
      max-width: 210px;
      word-break: break-word;
      font-size: 1em;
      background: #f9f7f0;
      color: #8b6e19;
    }
    .group-names-list { background: #f6f9ff; border: 1.2px solid var(--gray); border-radius: 7px; padding: 13px 7px 10px 7px; margin-bottom: 18px; box-shadow: 0 1px 8px #02204307; direction: rtl;}
    .group-names-list span { display: inline-block; background: var(--accent); color: #fff; border-radius: 6px; padding: 5px 15px; margin: 4px 6px; font-size: 1.08em; font-weight: 500;}
    .group-block {
      background: #f8fbff;
      border: 2px solid #e3eaff;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 19px #2563eb13;
      padding: 14px 8px 22px 8px;
      position: relative;
    }
    .group-block-title {
      font-weight: bold;
      color: #2563eb;
      font-size: 1.16em;
      margin: 0 0 13px 0;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .group-block-title .btn-action.group-delete {
      margin-right: 0;
      margin-left: 0;
    }
    .edit-modal {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(45,45,60,0.13);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .edit-modal.hide { display: none !important; }
    .edit-box {
      background: #fff;
      padding: 30px 28px 22px 28px;
      border-radius: 18px;
      box-shadow: 0 6px 50px #02204341;
      min-width: 330px;
      max-width: 97vw;
      border: 2.2px solid var(--primary);
      position: relative;
      font-size: 1.08em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .edit-box h2 {
      color: var(--primary);
      margin-bottom: 13px;
      font-size: 1.21em;
      letter-spacing: 0.4px;
    }
    .edit-form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 13px 22px;
      width: 100%;
      margin-bottom: 14px;
      align-items: end;
    }
    .edit-form-grid label {
      color: var(--primary-hover);
      font-weight: 600;
      font-size: 1em;
      margin-bottom: 3px;
      display: block;
      text-align: right;
      letter-spacing: 0.2px;
    }
    .edit-form-grid input,
    .edit-form-grid select,
    .edit-form-grid textarea {
      width: 100%;
      padding: 8px 7px;
      border-radius: 7px;
      border: 1.3px solid var(--gray);
      font-size: 1.09em;
      font-family: inherit;
      margin-bottom: 2px;
      background: #f8fbff;
      transition: border 0.16s;
      box-sizing: border-box;
      outline: none;
    }
    .edit-form-grid textarea {
      resize: vertical;
      min-height: 36px;
      max-height: 100px;
    }
    .edit-form-grid input:focus,
    .edit-form-grid select:focus,
    .edit-form-grid textarea:focus {
      border-color: var(--primary);
    }
    .edit-form-actions {
      width: 100%;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 13px;
      margin-top: 10px;
    }
    .edit-close {
      position: absolute;
      left: 18px; top: 11px;
      background: transparent;
      color: #ad1818;
      border: none;
      font-size: 1.3em;
      cursor: pointer;
      font-weight: bold;
      transition: color 0.18s;
    }
    .edit-close:hover { color: #d53a2c;}
    .number-cell {
      background: #e74c3c;
      color: #fff;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1em;
      padding: 4px 11px;
      box-shadow: 0 2px 7px #d53a2c22;
      display: inline-block;
      transition: background 0.2s;
    }
    .number-cell.paid {
      background: #2563eb;
      color: #fff;
    }
    .hide { display: none !important; }
    .hide-footer { display: none !important; }
    @media (max-width: 600px) {
      .edit-box {
        padding: 17px 4vw 14px 4vw;
        min-width: 95vw;
      }
      .edit-form-grid {
        grid-template-columns: 1fr;
        gap: 7px 0;
      }
      .edit-form-actions {
        flex-direction: column;
        gap: 7px;
      }
      .search-box { max-width: 95vw; }
    }
    @media (max-width:1000px){ .main-content { max-width: 99vw;} .stats-grid { flex-direction: column; gap:10px;}}
    @media (max-width: 700px) {
      .navbar-top {
        justify-content: center;
        padding: 0 10px;
      }
      .navbar-top nav {
        display: none !important;
      }
      .navbar-bottom {
        display: flex;
      }
      .main-content {
        margin-top: 22px;
        margin-bottom: calc(var(--nav-bottom-height) + 24px);
        border-radius: 16px;
        padding-top: 19px;
      }
    }
    @media (min-width: 701px) {
      .navbar-bottom {
        display: none !important;
      }
      .navbar-top nav {
        display: flex !important;
      }
      body {
        padding-bottom: 0 !important;
      }
      #mainFooter {
        margin-bottom: 0 !important;
      }
      html, body {
        height: 100%;
      }
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .main-content {
        flex: 1 0 auto;
      }
      #mainFooter {
        flex-shrink: 0;
      }
    }
    @media (max-width:600px) {
      .main-content { padding: 9vw 2vw 3vw 2vw; }
    }
    @media (max-width:430px){
      .main-content { padding: 5vw 1vw 3vw 1vw;}
      .navbar-top .logo { font-size: 1em;}
      .footer-links { flex-direction: column; gap:5px;}
      .navbar-bottom span { font-size: 0.93em; }
    }
    @media (max-width:350px){
      .navbar-bottom span { font-size: 0.75em; }
      .main-content h2 { font-size: 1em;}
    }



    .login-modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100vw; height: 100vh;
  background: rgba(45,53,76,0.11);
  z-index: 1600;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  min-width: 100vw;
  transition: background 0.3s;
}
.login-box {
  background: #fff;
  padding: 38px 32px 28px 32px;
  border-radius: 19px;
  box-shadow: 0 4px 40px #02204341;
  min-width: 320px;
  max-width: 98vw;
  text-align: center;
  border: 2px solid var(--primary);
  animation: fadeInUp 0.6s;
  z-index: 1800;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
}
.login-box-logo {
  font-size: 2.2em;
  color: var(--primary);
  background: #f4f7fb;
  border-radius: 50%;
  padding: 11px 18px;
  margin-bottom: 7px;
  box-shadow: 0 2px 16px #2563eb0d;
  display: inline-block;
}
.login-box h2 {
  color: var(--primary);
  margin-bottom: 16px;
  font-weight: bold;
  font-size: 1.22em;
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: center;
  letter-spacing: 0.5px;
}
.login-input-group {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  margin-bottom: 12px;
}
.login-input-group label {
  color: var(--primary);
  font-weight: bold;
  margin-bottom: 6px;
  font-size: 1.05em;
  text-align: right;
  width: 100%;
  display: flex;
  align-items: center;
  gap: 4px;
}
.login-input-group input[type="text"],
.login-input-group input[type="password"] {
  width: 100%;
  padding: 11px 9px;
  font-family: inherit;
  font-size: 1.14em;
  border: 1.3px solid var(--gray);
  border-radius: 7px;
  margin-bottom: 0;
  background: #f8fbff;
  transition: border 0.15s;
  box-sizing: border-box;
}
.login-input-group input:focus {
  border-color: var(--primary);
  outline: none;
  background: #f0f6ff;
}
.login-btn {
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 12px 34px;
  font-size: 1.14em;
  font-family: inherit;
  cursor: pointer;
  font-weight: bold;
  margin-top: 9px;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 12px #2563eb0c;
  transition: background 0.18s, transform 0.13s;
  display: flex;
  align-items: center;
  gap: 5px;
}
.login-btn:hover { background: var(--primary-hover); transform: scale(1.03);}
.login-error {
  color: #d53a2c;
  margin-bottom: 7px;
  font-size: 1.06em;
  font-weight: bold;
  min-height: 24px;
  text-align: center;
}
@media (max-width:600px) {
  .login-box { padding: 22px 2vw 14px 2vw; min-width: 90vw; }
}
  </style>
</head>
<body>
  <!-- Top Navbar (always visible, but no links in mobile) -->
  <header class="navbar-top" id="mainNavbar">
    <div class="logo">ICDL - Ziad Hagagy <i class="bi bi-mortarboard-fill"></i></div>
    <nav>
      <a href="./index.html">الرئيسية</a>
      <a href="./search.html">استعلام</a>
      <a href="./admin.html" class="active">لوحة التحكم</a>
    </nav>
  </header>
  <!-- Bottom Navigation Bar (mobile only) -->
  <nav class="navbar-bottom">
    <a href="./index.html">
      <i class="bi bi-house-fill"></i>
      <span>الرئيسية</span>
    </a>
    <a href="./search.html">
      <i class="bi bi-search"></i>
      <span>استعلام</span>
    </a>
    <a href="./admin.html" class="active">
      <i class="bi bi-bar-chart-line-fill"></i>
      <span>لوحة التحكم</span>
    </a>
  </nav>
  <!-- Login Modal -->
  <div id="loginModal" class="login-modal">
  <form class="login-box" onsubmit="return login(event)">
    <div class="login-box-logo">
      <i class="bi bi-mortarboard-fill"></i>
    </div>
    <h2><i class="bi bi-lock-fill"></i> تسجيل دخول الإدارة</h2>
    <div class="login-error" id="loginError"></div>
    <div class="login-input-group">
      <label for="adminUser"><i class="bi bi-person"></i> اسم المستخدم:</label>
      <input type="text" id="adminUser" autocomplete="off" required>
    </div>
    <div class="login-input-group">
      <label for="adminPass"><i class="bi bi-key"></i> كلمة المرور:</label>
      <input type="password" id="adminPass" autocomplete="off" required>
    </div>
    <button type="submit" class="login-btn"><i class="bi bi-box-arrow-in-right"></i> دخول</button>
  </form>
</div>
  <!-- Edit Modal -->
  <div id="editModal" class="edit-modal hide">
    <form class="edit-box" onsubmit="return saveEdit(event)">
      <button type="button" class="edit-close" onclick="closeEditModal()">&times;</button>
      <h2>تعديل بيانات الحجز</h2>
      <div class="edit-form-grid">
        <div>
          <label>الاسم:</label>
          <input id="editName" required>
        </div>
        <div>
          <label>العنوان:</label>
          <input id="editAddress" required>
        </div>
        <div>
          <label>الهاتف:</label>
          <input id="editPhone" required>
        </div>
        <div>
          <label>نوع الكورس:</label>
          <select id="editCourse" required>
            <option value="">اختر الكورس</option>
            <option value="icdl">ICDL</option>
            <option value="english">English</option>
            <option value="both">الاثنين معاً (ICDL - English)</option>
          </select>
        </div>
        <div>
          <label>تم الدفع:</label>
          <select id="editPaid" required>
            <option value="نعم">نعم</option>
            <option value="لا">لا</option>
          </select>
        </div>
        <div>
          <label>المجموعة:</label>
          <select id="editGroupSelect" required>
            <option value="individual" data-type="individual">(حجز فردي)</option>
          </select>
        </div>
        <div style="grid-column:1/-1">
          <label>تفاصيل إضافية (اختياري):</label>
          <textarea id="editDetails" rows="2" maxlength="300" placeholder="اكتب أي تفاصيل إضافية إن وجدت"></textarea>
        </div>
      </div>
      <div class="edit-form-actions">
        <input type="hidden" id="editKey">
        <input type="hidden" id="editType">
        <input type="hidden" id="editGroupOld">
        <button class="btn-action edit" type="submit">حفظ التعديل</button>
      </div>
    </form>
  </div>
  <!-- Add Group Modal -->
  <div id="addGroupModal" class="edit-modal hide">
    <form class="edit-box" onsubmit="return addGroup(event)">
      <button type="button" class="edit-close" onclick="closeAddGroupModal()">&times;</button>
      <h2>تسجيل مجموعة جديدة</h2>
      <div style="margin-bottom: 18px; width: 100%;">
        <label style="color: var(--primary-hover); font-weight: 600; font-size: 1em; display: block; text-align: right;">اسم المجموعة:</label>
        <input id="newGroupName" required style="width:100%;padding:8px 7px;border-radius:7px;border:1.3px solid var(--gray);font-size:1.09em;font-family:inherit;">
      </div>
      <div class="edit-form-actions">
        <button class="btn-action edit" type="submit">إضافة المجموعة</button>
      </div>
    </form>
  </div>
  <main class="main-content hide" id="adminContent">
    <h2><i class="bi bi-speedometer2"></i> لوحة التحكم والإحصائيات</h2>
    <div class="stats-grid" id="specialStats"></div>
    <div class="section-title"><i class="bi bi-bar-chart-line-fill"></i> إحصائيات عامة
      <button class="btn-print" onclick="printStatsAndSummary()"><i class="bi bi-printer"></i> طباعة التفاصيل</button>
    </div>
    <div class="stats-grid" id="mainStats"></div>
    <div class="section-title"><i class="bi bi-cash-coin"></i> إجمالي أسعار الحجوزات الفردية والاثنين معاً</div>
    <div class="stats-grid" id="summaries"></div>
    <div class="section-title" style="align-items: center;">
      <i class="bi bi-people-fill"></i> أسماء المجموعات
      <button class="btn-add-group" onclick="showAddGroupModal()"><i class="bi bi-plus-circle"></i> تسجيل مجموعة جديدة</button>
    </div>
    <div class="group-names-list" id="groupNames"></div>
    <div class="section-title">
      <i class="bi bi-person-lines-fill"></i> تفاصيل الحجز الفردي
      <button class="btn-print" onclick="printTable('tblIndividual', 'تفاصيل الحجز الفردي')"><i class="bi bi-printer"></i> طباعة الجدول</button>
    </div>
    <div class="search-box">
      <input type="text" id="studentSearch" placeholder="ابحث باسم الطالب..." oninput="filterStudentTables()" />
      <i class="bi bi-search"></i>
    </div>
    <div style="overflow-x:auto;">
      <table class="tbl" id="tblIndividual">
        <thead>
          <tr>
            <th>#</th>
            <th>الاسم</th>
            <th>العنوان</th>
            <th>الهاتف</th>
            <th>نوع الكورس</th>
            <th>تم الدفع</th>
            <th>المبلغ</th>
            <th class="details-col">التفاصيل</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="section-title">
      <i class="bi bi-people"></i> تفاصيل الحجز في المجموعات
    </div>
    <div id="groupsContainer"></div>
  </main>
  <footer id="mainFooter">
    <div class="footer-links">
      <a href="#">عن الموقع</a>
      <a href="#">سياسة الخصوصية</a>
      <a href="#">الشروط والأحكام</a>
    </div>
    <div class="social">
      <a href="#"><i class="bi bi-facebook"></i></a>
      <a href="#"><i class="bi bi-whatsapp"></i></a>
      <a href="#"><i class="bi bi-envelope"></i></a>
    </div>
    <div class="copy">جميع الحقوق محفوظة &copy; زياد حجاجي 2025</div>
  </footer>
  <div id="printArea" style="display:none"></div>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // --- إعدادات أساسية ---
    const ADMIN_USERNAME = "admin";
    const ADMIN_PASSWORD = "4159";
    const DELETE_CONFIRM_PASSWORD = "17822893";
    const COURSE_PRICE = 500;
    firebase.initializeApp({
      apiKey: "AIzaSyB_qOr1RzbdvhFGPefXaTMYmflssfbUrS0",
      authDomain: "icdl-261b4.firebaseapp.com",
      databaseURL: "https://icdl-261b4-default-rtdb.firebaseio.com",
      projectId: "icdl-261b4",
      storageBucket: "icdl-261b4.firebasestorage.app",
      messagingSenderId: "1034739256423",
      appId: "1:1034739256423:web:872187720b49d2a5ebd8c2"
    });
    const db = firebase.database();

    let cachedGroupNames = [];
    let lastIndRows = "";
    let lastGroupTables = {};

    // تسجيل الدخول
    function login(e) {
      e.preventDefault();
      const username = document.getElementById('adminUser').value.trim();
      const password = document.getElementById('adminPass').value;
      if(username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        document.getElementById('loginModal').classList.add('hide');
        document.getElementById('adminContent').classList.remove('hide');
        document.getElementById('mainFooter').classList.remove('hide-footer');
        loadDashboard();
      } else {
        document.getElementById('loginError').innerText = "اسم المستخدم أو كلمة المرور غير صحيحة!";
      }
      return false;
    }
    window.onload = function() {
      document.getElementById('mainFooter').classList.add('hide-footer');
    };

    // تحميل الداشبورد
    async function loadDashboard() {
      let stats = {
        countICDL: 0, countEnglish: 0, countBoth: 0,
        totalICDL: 0, totalEnglish: 0, totalBoth: 0,
        paidICDL: 0, paidEnglish: 0, paidBoth: 0,
        totalPaid: 0, totalPersons: 0, totalInGroups: 0, totalIndividual: 0,
        groupNames: [],
        totalIndividualPrice: 0, totalIndividualBothPrice: 0, totalGroupIndividualPrice: 0, totalGroupBothPrice: 0,
        unpaidPersonsCount: 0,
        unpaidTotalAmount: 0,
        countICDLAny: 0,
        countEnglishAny: 0,
        unpaidICDL: 0,
        unpaidEnglish: 0
      };
      let tblIndRows = "";
      cachedGroupNames = [];
      lastIndRows = "";
      lastGroupTables = {};

      let snapshotGroupsNames = await db.ref("groups").once("value");
      snapshotGroupsNames.forEach(groupChild => {
        const groupName = groupChild.key;
        cachedGroupNames.push(groupName);
        stats.groupNames.push(groupName);
      });

      let snapshotInd = await db.ref("individual_requests").once("value");
      let indIndex = 1;
      snapshotInd.forEach(child => {
        const key = child.key;
        const v = child.val();
        let courseType = (v.course || "").toLowerCase();
        let price = 0;
        let paid = v.paid === "نعم" || v.paid === "yes";
        if(courseType === "icdl")      { price = COURSE_PRICE; stats.countICDL++; stats.totalIndividualPrice += price; }
        else if(courseType === "english") { price = COURSE_PRICE; stats.countEnglish++; stats.totalIndividualPrice += price; }
        else if(courseType === "both" || courseType === "الاثنين معاً") { price = COURSE_PRICE*2; stats.countBoth++; stats.totalIndividualBothPrice += price; }
        else price = 0;

        if(paid && (courseType === "icdl" || courseType === "both" || courseType === "الاثنين معاً")) stats.countICDLAny++;
        if(paid && (courseType === "english" || courseType === "both" || courseType === "الاثنين معاً")) stats.countEnglishAny++;
        if(!paid && (courseType === "icdl" || courseType === "both" || courseType === "الاثنين معاً")) stats.unpaidICDL++;
        if(!paid && (courseType === "english" || courseType === "both" || courseType === "الاثنين معاً")) stats.unpaidEnglish++;

        tblIndRows += `<tr>
          <td><span class="number-cell${paid ? ' paid' : ''}">${indIndex++}</span></td>
          <td>${v.name || ""}</td>
          <td>${v.address || ""}</td>
          <td>${v.phone || ""}</td>
          <td>${displayCourseType(v.course)}</td>
          <td>${v.paid || ""}</td>
          <td>${price} جم</td>
          <td class="details-col">${(v.details && v.details.trim()) ? escapeHtml(v.details) : '<span style="color:#aaa">-</span>'}</td>
          <td>
            <button class="btn-action edit" onclick="showEditModal('individual','${key}')"><i class="bi bi-pencil"></i></button>
            <button class="btn-action delete" onclick="deletePerson('individual','${key}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>`;
        stats.totalPersons++;
        stats.totalIndividual++;
        if(paid){
          if(courseType === "icdl") stats.paidICDL += price;
          if(courseType === "english") stats.paidEnglish += price;
          if(courseType === "both" || courseType === "الاثنين معاً") stats.paidBoth += price;
          stats.totalPaid += price;
        } else {
          stats.unpaidPersonsCount++;
          stats.unpaidTotalAmount += price;
        }
      });
      lastIndRows = tblIndRows;
      document.querySelector('#tblIndividual tbody').innerHTML = tblIndRows || `<tr><td colspan="9">لا يوجد حجوزات فردية</td></tr>`;

      let snapshotGroups = await db.ref("groups").once("value");
      let groupHtmlBlocks = [];
      snapshotGroups.forEach(groupChild => {
        const groupName = groupChild.key;
        const requests = groupChild.child("requests");
        let groupRows = "";
        let membersCount = 0;
        let rowIndex = 1;
        if(requests.exists()) {
          requests.forEach(reqChild => {
            const key = reqChild.key;
            const v = reqChild.val();
            let courseType = (v.course || "").toLowerCase();
            let price = 0;
            let paid = v.paid === "نعم" || v.paid === "yes";
            if(courseType === "icdl")      { price = COURSE_PRICE; stats.countICDL++; stats.totalGroupIndividualPrice += price; }
            else if(courseType === "english") { price = COURSE_PRICE; stats.countEnglish++; stats.totalGroupIndividualPrice += price; }
            else if(courseType === "both" || courseType === "الاثنين معاً") { price = COURSE_PRICE*2; stats.countBoth++; stats.totalGroupBothPrice += price; }
            else price = 0;

            if(paid && (courseType === "icdl" || courseType === "both" || courseType === "الاثنين معاً")) stats.countICDLAny++;
            if(paid && (courseType === "english" || courseType === "both" || courseType === "الاثنين معاً")) stats.countEnglishAny++;
            if(!paid && (courseType === "icdl" || courseType === "both" || courseType === "الاثنين معاً")) stats.unpaidICDL++;
            if(!paid && (courseType === "english" || courseType === "both" || courseType === "الاثنين معاً")) stats.unpaidEnglish++;

            groupRows += `<tr>
              <td><span class="number-cell${paid ? ' paid' : ''}">${rowIndex++}</span></td>
              <td>${v.name || ""}</td>
              <td>${v.address || ""}</td>
              <td>${v.phone || ""}</td>
              <td>${displayCourseType(v.course)}</td>
              <td>${v.paid || ""}</td>
              <td>${price} جم</td>
              <td class="details-col">${(v.details && v.details.trim()) ? escapeHtml(v.details) : '<span style="color:#aaa">-</span>'}</td>
              <td>
                <button class="btn-action edit" onclick="showEditModal('group','${key}','${groupName}')"><i class="bi bi-pencil"></i></button>
                <button class="btn-action delete" onclick="deletePerson('group','${key}','${groupName}')"><i class="bi bi-trash"></i></button>
              </td>
            </tr>`;
            stats.totalPersons++;
            stats.totalInGroups++;
            membersCount++;
            if(paid){
              if(courseType === "icdl") stats.paidICDL += price;
              if(courseType === "english") stats.paidEnglish += price;
              if(courseType === "both" || courseType === "الاثنين معاً") stats.paidBoth += price;
              stats.totalPaid += price;
            } else {
              stats.unpaidPersonsCount++;
              stats.unpaidTotalAmount += price;
            }
          });
        }
        lastGroupTables[groupName] = groupRows;
        groupHtmlBlocks.push(`
          <div class="group-block">
            <div class="group-block-title">
              <i class="bi bi-collection"></i> مجموعة: <span>${groupName}</span>
              <span style="color:#8c8c8c;font-size:0.95em">(عدد الأعضاء: ${membersCount})</span>
              <button class="btn-print" onclick="printGroupTable('${groupName.replace(/'/g,"\\'")}')"><i class="bi bi-printer"></i> طباعة الجدول</button>
              <button class="btn-action group-delete" title="حذف المجموعة" onclick="deleteGroup('${groupName.replace(/'/g,"\\'")}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
            <div style="overflow-x:auto;">
              <table class="tbl" id="tblGroup_${encodeURIComponent(groupName)}">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>الاسم</th>
                    <th>العنوان</th>
                    <th>الهاتف</th>
                    <th>نوع الكورس</th>
                    <th>تم الدفع</th>
                    <th>المبلغ</th>
                    <th class="details-col">التفاصيل</th>
                    <th>إجراءات</th>
                  </tr>
                </thead>
                <tbody>
                  ${groupRows || `<tr><td colspan="9">لا يوجد أعضاء في هذه المجموعة</td></tr>`}
                </tbody>
              </table>
            </div>
          </div>
        `);
      });
      document.getElementById('groupsContainer').innerHTML = groupHtmlBlocks.length ? groupHtmlBlocks.join('') : '<div style="color:#888;">لا توجد مجموعات مسجلة</div>';

      stats.totalICDL = stats.countICDL * COURSE_PRICE;
      stats.totalEnglish = stats.countEnglish * COURSE_PRICE;
      stats.totalBoth = stats.countBoth * COURSE_PRICE * 2;

      // special statistics أعلى الصفحة: فقط الدافعين لأي كورس icdl أو english + الغير دافعين تحته بخط صغير
      let specialStatsHtml = `
        <div class="stat-card special">
          <div>
            <i class="bi bi-check-circle" style="color:#1786dc;font-size:1.1em"></i>
            عدد الطلبة الدافعين في كورس <span style="color:#2563eb">ICDL</span> (فردي أو الاثنين معًا):
            <strong>${stats.countICDLAny}</strong>
            <span class="stat-note">عدد الغير دافعين: ${stats.unpaidICDL}</span>
          </div>
        </div>
        <div class="stat-card special">
          <div>
            <i class="bi bi-check-circle" style="color:#21a25e;font-size:1.1em"></i>
            عدد الطلبة الدافعين في كورس <span style="color:#13a041">English</span> (فردي أو الاثنين معًا):
            <strong>${stats.countEnglishAny}</strong>
            <span class="stat-note">عدد الغير دافعين: ${stats.unpaidEnglish}</span>
          </div>
        </div>
      `;
      document.getElementById('specialStats').innerHTML = specialStatsHtml;

      let mainStatsHtml = `
        <div class="stat-card">
          <div>عدد الطلبة (الكل):</div>
          <strong>${stats.totalPersons}</strong>
        </div>
        <div class="stat-card">
          <div>عدد الطلبة الأفراد:</div>
          <strong>${stats.totalIndividual}</strong>
        </div>
        <div class="stat-card">
          <div>عدد الطلبة في المجموعات:</div>
          <strong>${stats.totalInGroups}</strong>
        </div>
        <div class="stat-card">
          <div>عدد حجوزات ICDL:</div>
          <strong>${stats.countICDL}</strong>
        </div>
        <div class="stat-card">
          <div>عدد حجوزات English:</div>
          <strong>${stats.countEnglish}</strong>
        </div>
        <div class="stat-card">
          <div>عدد حجوزات الاثنين معاً:</div>
          <strong>${stats.countBoth}</strong>
        </div>
        <div class="stat-card">
          <div>إجمالي المدفوع:</div>
          <strong>${stats.totalPaid} جم</strong>
        </div>
        <div class="stat-card">
          <div>مدفوع ICDL:</div>
          <strong>${stats.paidICDL} جم</strong>
        </div>
        <div class="stat-card">
          <div>مدفوع English:</div>
          <strong>${stats.paidEnglish} جم</strong>
        </div>
        <div class="stat-card">
          <div>مدفوع الاثنين معاً:</div>
          <strong>${stats.paidBoth} جم</strong>
        </div>
        <div class="stat-card unpaid">
          <div>عدد الأشخاص الغير دافعين:</div>
          <strong>${stats.unpaidPersonsCount}</strong>
        </div>
        <div class="stat-card unpaid">
          <div>إجمالي الغير مدفوع:</div>
          <strong>${stats.unpaidTotalAmount} جم</strong>
        </div>
      `;
      document.getElementById('mainStats').innerHTML = mainStatsHtml;

      let summariesHtml = `
        <div class="stat-card">
          <div>إجمالي سعر الحجز المدفوع (ICDL و English فقط):</div>
          <strong>${stats.totalPaid} جم</strong>
        </div>
        <div class="stat-card unpaid">
          <div>إجمالي سعر الحجز الغير مدفوع:</div>
          <strong>${stats.unpaidTotalAmount} جم</strong>
        </div>
      `;
      document.getElementById('summaries').innerHTML = summariesHtml;

      document.getElementById('groupNames').innerHTML = stats.groupNames.length ?
        stats.groupNames.map(name => `<span>${name}</span>`).join("") :
        "<em>لا توجد مجموعات بعد</em>";

      document.getElementById('studentSearch').value = "";
    }

    // فلترة الجداول عند البحث
    function filterStudentTables() {
      const searchValue = document.getElementById('studentSearch').value.trim().toLowerCase();
      // فلترة جدول الأفراد
      let table = document.getElementById('tblIndividual');
      let tbody = table.querySelector('tbody');
      if (!lastIndRows) {
        lastIndRows = tbody.innerHTML;
      }
      let tempTbody = document.createElement('tbody');
      tempTbody.innerHTML = lastIndRows;
      let allRows = Array.from(tempTbody.querySelectorAll('tr'));
      let filteredRows = allRows.filter(row => {
        let nameCell = row.children[1];
        if (!nameCell) return false;
        let name = nameCell.textContent.trim().toLowerCase();
        return name.includes(searchValue);
      });
      tbody.innerHTML = filteredRows.length ? filteredRows.map(r=>r.outerHTML).join("") : `<tr><td colspan="9">لا يوجد نتائج مطابقة</td></tr>`;
      // فلترة جداول المجموعات
      let groupBlocks = document.querySelectorAll('.group-block');
      groupBlocks.forEach(block => {
        let table = block.querySelector('table.tbl');
        let tbody = table.querySelector('tbody');
        let groupName = table.id.replace('tblGroup_', '');
        let originalRows = lastGroupTables[decodeURIComponent(groupName)] || "";
        let tempTbody = document.createElement('tbody');
        tempTbody.innerHTML = originalRows;
        let allRows = Array.from(tempTbody.querySelectorAll('tr'));
        let filteredRows = allRows.filter(row => {
          let nameCell = row.children[1];
          if (!nameCell) return false;
          let name = nameCell.textContent.trim().toLowerCase();
          return name.includes(searchValue);
        });
        tbody.innerHTML = filteredRows.length ? filteredRows.map(r=>r.outerHTML).join("") : `<tr><td colspan="9">لا يوجد نتائج مطابقة</td></tr>`;
      });
    }

    function displayCourseType(type) {
      if (!type) return '';
      if (type.toLowerCase() === "icdl") return "ICDL";
      if (type.toLowerCase() === "english") return "English";
      if (type.toLowerCase() === "both" || type === "الاثنين معاً") return "الاثنين معاً (ICDL - English)";
      return type;
    }

    function printStatsAndSummary() {
      var statsHtml = document.querySelector('.section-title').outerHTML + document.getElementById('mainStats').outerHTML;
      var summariesHtml = document.querySelectorAll('.section-title')[1].outerHTML + document.getElementById('summaries').outerHTML;
      var groupNamesTitle = document.querySelectorAll('.section-title')[2].outerHTML;
      var groupNamesHtml = document.getElementById('groupNames').outerHTML;
      var printArea = document.getElementById('printArea');
      printArea.innerHTML = statsHtml + summariesHtml + groupNamesTitle + groupNamesHtml;
      printArea.style.display = 'block';
      printArea.setAttribute('dir', 'rtl');
      printArea.id = "printArea";
      window.print();
      printArea.innerHTML = "";
      printArea.style.display = 'none';
    }

    function printTable(tableId, title) {
      var tbl = document.getElementById(tableId);
      if (!tbl) return;
      var printArea = document.getElementById('printArea');
      var html = `<h3 style="text-align:center;color:#2563eb;font-family:Cairo,Arial,sans-serif;margin:15px 0">${title}</h3>`;
      html += `<div style="overflow-x:auto;">${tbl.outerHTML}</div>`;
      printArea.innerHTML = html;
      printArea.style.display = 'block';
      printArea.setAttribute('dir', 'rtl');
      window.print();
      printArea.innerHTML = "";
      printArea.style.display = 'none';
    }

    function printGroupTable(groupName) {
      var tbl = document.getElementById('tblGroup_' + encodeURIComponent(groupName));
      if (!tbl) return;
      var html = `<h3 style="text-align:center;color:#2563eb;font-family:Cairo,Arial,sans-serif;margin:15px 0">جدول مجموعة: ${groupName}</h3>`;
      html += `<div style="overflow-x:auto;">${tbl.outerHTML}</div>`;
      var printArea = document.getElementById('printArea');
      printArea.innerHTML = html;
      printArea.style.display = 'block';
      printArea.setAttribute('dir', 'rtl');
      window.print();
      printArea.innerHTML = "";
      printArea.style.display = 'none';
    }

    // حذف طالب فردي أو من مجموعة مع تأكيد كلمة سر
    function deletePerson(type, key, groupName) {
      if (!confirm('هل أنت متأكد من حذف هذا الشخص؟')) return;
      let pass = prompt("ادخل الرقم السري الخاص بالحذف:");
      if (pass === null) return;
      if (pass !== DELETE_CONFIRM_PASSWORD) {
        alert("الرقم السري غير صحيح. لم يتم تنفيذ الحذف.");
        return;
      }
      if (type === 'individual') {
        db.ref('individual_requests/' + key).remove().then(() => {
          alert('تم حذف الشخص بنجاح');
          loadDashboard();
        });
      } else if (type === 'group' && groupName) {
        db.ref('groups/' + groupName + '/requests/' + key).remove().then(() => {
          alert('تم حذف الشخص من المجموعة بنجاح');
          loadDashboard();
        });
      }
    }

    // حذف مجموعة كاملة مع تأكيد كلمة سر
    function deleteGroup(groupName) {
      if (!confirm('هل أنت متأكد أنك تريد حذف المجموعة بالكامل؟ سيتم حذف جميع الأعضاء أيضاً!')) return;
      let pass = prompt("ادخل الرقم السري الخاص بالحذف:");
      if (pass === null) return;
      if (pass !== DELETE_CONFIRM_PASSWORD) {
        alert("الرقم السري غير صحيح. لم يتم تنفيذ الحذف.");
        return;
      }
      db.ref('groups/' + groupName).remove().then(() => {
        alert('تم حذف المجموعة بنجاح');
        loadDashboard();
      });
    }

    // إظهار نافذة إضافة مجموعة
    function showAddGroupModal() {
      document.getElementById('addGroupModal').classList.remove('hide');
      document.getElementById('newGroupName').value = '';
      setTimeout(() => {
        document.getElementById('newGroupName').focus();
      }, 200);
    }
    // إغلاق نافذة إضافة مجموعة
    function closeAddGroupModal() {
      document.getElementById('addGroupModal').classList.add('hide');
    }
    // إضافة مجموعة جديدة
    async function addGroup(e) {
      e.preventDefault();
      const name = document.getElementById('newGroupName').value.trim();
      if (!name) {
        alert('الرجاء إدخال اسم المجموعة');
        return false;
      }
      // تحقق إذا كانت المجموعة موجودة مسبقاً
      let snap = await db.ref('groups/' + name).once('value');
      if (snap.exists()) {
        alert('اسم المجموعة موجود بالفعل');
        return false;
      }
      await db.ref('groups/' + name).set({ created: Date.now() });
      alert('تم إضافة المجموعة بنجاح');
      closeAddGroupModal();
      loadDashboard();
      return false;
    }

    // المودال الخاص بالتعديل
    async function showEditModal(type, key, groupName) {
      const select = document.getElementById('editGroupSelect');
      select.innerHTML = `<option value="individual" data-type="individual">(حجز فردي)</option>`;
      cachedGroupNames.forEach(g => {
        select.innerHTML += `<option value="${g}" data-type="group">${g}</option>`;
      });

      let data;
      if (type === 'individual') {
        let snap = await db.ref('individual_requests/' + key).once('value');
        data = snap.val();
        select.value = "individual";
      } else if (type === 'group' && groupName) {
        let snap = await db.ref('groups/' + groupName + '/requests/' + key).once('value');
        data = snap.val();
        select.value = groupName;
      }
      if(!data) return alert('لا يوجد بيانات!');
      document.getElementById('editKey').value = key;
      document.getElementById('editType').value = type;
      document.getElementById('editGroupOld').value = groupName || "";
      document.getElementById('editName').value = data.name || '';
      document.getElementById('editAddress').value = data.address || '';
      document.getElementById('editPhone').value = data.phone || '';
      let vCourse = (data.course || '').toLowerCase();
      if (vCourse === 'icdl') document.getElementById('editCourse').value = 'icdl';
      else if (vCourse === 'english') document.getElementById('editCourse').value = 'english';
      else document.getElementById('editCourse').value = 'both';
      document.getElementById('editPaid').value = (data.paid === 'yes' || data.paid === 'نعم') ? 'نعم' : 'لا';
      document.getElementById('editDetails').value = data.details || '';
      document.getElementById('editModal').classList.remove('hide');
    }
    function closeEditModal() {
      document.getElementById('editModal').classList.add('hide');
    }

    // حفظ التعديل
    async function saveEdit(e) {
      e.preventDefault();
      const key = document.getElementById('editKey').value;
      const oldType = document.getElementById('editType').value;
      const oldGroup = document.getElementById('editGroupOld').value;
      const selectedGroup = document.getElementById('editGroupSelect').value;
      const data = {
        name: document.getElementById('editName').value.trim(),
        address: document.getElementById('editAddress').value.trim(),
        phone: document.getElementById('editPhone').value.trim(),
        course: document.getElementById('editCourse').value,
        paid: document.getElementById('editPaid').value,
        details: document.getElementById('editDetails').value.trim()
      };
      if (oldType === 'individual' && selectedGroup !== "individual") {
        await db.ref('individual_requests/' + key).remove();
        await db.ref('groups/' + selectedGroup + '/requests/' + key).set(data);
      } else if (oldType === 'group' && selectedGroup === "individual") {
        await db.ref('groups/' + oldGroup + '/requests/' + key).remove();
        await db.ref('individual_requests/' + key).set(data);
      } else if (oldType === 'group' && selectedGroup !== oldGroup && selectedGroup !== "individual") {
        await db.ref('groups/' + oldGroup + '/requests/' + key).remove();
        await db.ref('groups/' + selectedGroup + '/requests/' + key).set(data);
      } else if (oldType === 'individual' && selectedGroup === "individual") {
        await db.ref('individual_requests/' + key).set(data);
      } else if (oldType === 'group' && selectedGroup === oldGroup) {
        await db.ref('groups/' + oldGroup + '/requests/' + key).set(data);
      }
      alert('تم حفظ التعديلات بنجاح');
      closeEditModal();
      loadDashboard();
    }

    // Escape HTML for details column
    function escapeHtml(s) {
      if (!s) return "";
      return s.replace(/&/g, "&amp;").replace(/</g, "&lt;")
              .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
    }

    document.addEventListener("contextmenu", function (e) {
      e.preventDefault();
    });
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" ||
        (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
        (e.ctrlKey && e.key === "U")) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
